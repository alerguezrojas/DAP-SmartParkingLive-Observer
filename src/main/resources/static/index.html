<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartParking Live | Dashboard Profesional</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Toast Container -->
        <div id="toast-container" class="toast-container"></div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fa-solid fa-square-parking logo-icon"></i>
                <h2>SmartParking</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="active" data-target="dashboard-view"><a href="#"><i class="fa-solid fa-chart-pie"></i> Dashboard</a></li>
                    <li data-target="kdd-view"><a href="#"><i class="fa-solid fa-users"></i> KDDs / Eventos</a></li>
                    <li><a href="#"><i class="fa-solid fa-car"></i> Plazas</a></li>
                    <li><a href="#"><i class="fa-solid fa-clock-rotate-left"></i> Historial</a></li>
                    <li><a href="#"><i class="fa-solid fa-gear"></i> Configuración</a></li>
                </ul>
                
                <div style="padding: 15px 20px 5px; font-size: 0.75rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Usuarios Registrados</div>
                <ul id="sidebar-user-list" style="list-style: none; padding: 0;">
                    <!-- Users loaded via JS -->
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="avatar">A</div>
                    <div class="user-details">
                        <span class="name">Admin User</span>
                        <span class="role">Administrador</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-title">
                    <h1>Dashboard en Tiempo Real</h1>
                    <p>Monitorización y gestión de plazas de aparcamiento</p>
                </div>
                <div class="header-actions">
                    <div class="parking-selector-container" style="margin-right: 15px;">
                        <select id="parking-selector" class="parking-select" style="padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0; background-color: white; font-family: inherit; font-size: 0.9rem; cursor: pointer;">
                            <option value="" disabled selected>Cargando parkings...</option>
                        </select>
                    </div>
                    <div class="health-status-pill" id="health-pill">
                        <span class="pill-dot" id="health-dot"></span>
                        <div class="pill-text">
                            <span id="health-status-text">Sin datos</span>
                            <small id="health-updated">Feed: -</small>
                        </div>
                    </div>
                    <div class="connection-status">
                        <span id="connection-indicator" class="indicator disconnected"></span>
                        <span id="connection-text">Desconectado</span>
                    </div>
                    <button class="icon-btn"><i class="fa-regular fa-bell"></i></button>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div id="dashboard-view" class="view-section">
                <!-- Statistics Cards -->
                <section class="stats-grid">
                    <div class="stat-card total">
                        <div class="stat-icon"><i class="fa-solid fa-warehouse"></i></div>
                        <div class="stat-info">
                            <h3>Total Plazas</h3>
                            <p id="total-spots" class="stat-value">0</p>
                        </div>
                    </div>
                    <div class="stat-card free">
                        <div class="stat-icon"><i class="fa-solid fa-check-circle"></i></div>
                        <div class="stat-info">
                            <h3>Disponibles</h3>
                            <p id="free-spots" class="stat-value">0</p>
                        </div>
                    </div>
                    <div class="stat-card occupied">
                        <div class="stat-icon"><i class="fa-solid fa-car-side"></i></div>
                        <div class="stat-info">
                            <h3>Ocupadas</h3>
                            <p id="occupied-spots" class="stat-value">0</p>
                        </div>
                    </div>
                    <div class="stat-card out-of-service">
                        <div class="stat-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                        <div class="stat-info">
                            <h3>Mantenimiento</h3>
                            <p id="out-of-service-spots" class="stat-value">0</p>
                        </div>
                    </div>
                    <div class="stat-card health">
                        <div class="stat-icon"><i class="fa-solid fa-heartbeat"></i></div>
                        <div class="stat-info">
                            <h3>Salud sistema</h3>
                            <p id="health-status-card" class="stat-value">-</p>
                            <small id="health-latency">Feed: -</small>
                        </div>
                    </div>
                </section>

                <!-- Charts Section -->
                <section class="charts-section" style="margin-bottom: 2rem; display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem;">
                    <div class="card chart-card" style="padding: 1.5rem;">
                        <div class="card-header" style="margin-bottom: 1rem;">
                            <h3><i class="fa-solid fa-chart-pie"></i> Distribución Actual</h3>
                        </div>
                        <div class="card-body" style="height: 300px; position: relative;">
                            <canvas id="parkingChart"></canvas>
                        </div>
                    </div>
                    <div class="card chart-card" style="padding: 1.5rem;">
                        <div class="card-header" style="margin-bottom: 1rem;">
                            <h3><i class="fa-solid fa-chart-line"></i> Histórico Completo</h3>
                        </div>
                        <div class="card-body" style="height: 300px; position: relative;">
                            <canvas id="historyChart"></canvas>
                        </div>
                    </div>
                </section>

                <div class="content-grid">
                    <!-- Parking Grid Section -->
                    <section class="parking-section card">
                        <div class="card-header">
                            <h2><i class="fa-solid fa-map-location-dot"></i> Mapa de Plazas</h2>
                            <div class="legend">
                                <span class="legend-item"><span class="dot free"></span> Libre</span>
                                <span class="legend-item"><span class="dot occupied"></span> Ocupada</span>
                                <span class="legend-item"><span class="dot maintenance"></span> Mantenimiento</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="parking-grid" class="parking-grid">
                                <!-- Las plazas se generarán dinámicamente -->
                            </div>
                        </div>
                    </section>

                    <!-- Sidebar Right: Controls & Logs -->
                    <div class="sidebar-right">
                        <!-- Pricing -->
                        <section class="pricing-section card">
                            <div class="card-header">
                                <h2><i class="fa-solid fa-ticket"></i> Cotizador de Tarifas</h2>
                            </div>
                            <div class="card-body pricing-body">
                                <div class="control-group">
                                    <label for="pricing-minutes">Minutos de estancia</label>
                                    <input id="pricing-minutes" type="number" min="15" step="15" value="60">
                                </div>
                                <div class="control-row">
                                    <label class="checkbox">
                                        <input id="pricing-subscriber" type="checkbox"> Suscriptor
                                    </label>
                                    <label class="checkbox">
                                        <input id="pricing-ev" type="checkbox"> Vehículo eléctrico
                                    </label>
                                </div>
                                <div class="control-group">
                                    <label for="pricing-start">Hora de inicio</label>
                                    <input id="pricing-start" type="datetime-local">
                                </div>
                                <button class="btn-primary" onclick="calculateQuote()">
                                    <i class="fa-solid fa-calculator"></i> Calcular
                                </button>
                                <div id="pricing-result" class="pricing-result">
                                    <p class="muted">Introduce datos y calcula para ver el desglose.</p>
                                </div>
                            </div>
                        </section>

                        <!-- Controls -->
                        <section class="controls-section card">
                            <div class="card-header">
                                <h2><i class="fa-solid fa-sliders"></i> Panel de Control</h2>
                            </div>
                            <div class="card-body">
                                <div class="control-group">
                                    <label for="spot-selector">Seleccionar Plaza</label>
                                    <div class="select-wrapper">
                                        <select id="spot-selector">
                                            <option value="">-- Seleccione --</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down"></i>
                                    </div>
                                </div>

                                <div class="control-group">
                                    <label for="status-selector">Nuevo Estado</label>
                                    <div class="select-wrapper">
                                        <select id="status-selector">
                                            <option value="FREE">Libre</option>
                                            <option value="OCCUPIED">Ocupada</option>
                                            <option value="OUT_OF_SERVICE">Mantenimiento</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down"></i>
                                    </div>
                                </div>

                                <button id="update-btn" onclick="updateSpotStatus()" class="btn-primary">
                                    <i class="fa-solid fa-rotate"></i> Actualizar Estado
                                </button>
                            </div>
                        </section>

                        <!-- Activity Log -->
                        <section class="activity-section card">
                            <div class="card-header">
                                <h2><i class="fa-solid fa-list-ul"></i> Actividad Reciente</h2>
                            </div>
                            <div class="card-body">
                                <div id="activity-log" class="activity-log">
                                    <!-- Los logs se añadirán dinámicamente -->
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- KDD View -->
            <div id="kdd-view" class="view-section" style="display: none;">
                <div class="kdd-container" style="padding: 20px;">
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <h2><i class="fa-solid fa-user-plus"></i> Registro de Usuario KDD</h2>
                        </div>
                        <div class="card-body" style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="kdd-username" placeholder="Tu nombre" class="form-control" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
                            <input type="number" id="kdd-lat" placeholder="Latitud" value="40.416" class="form-control" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 100px;">
                            <input type="number" id="kdd-lon" placeholder="Longitud" value="-3.703" class="form-control" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 100px;">
                            <label><input type="checkbox" id="kdd-ismod"> Es Mod?</label>
                            <button onclick="registerKddUser()" class="btn-primary" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 6px; cursor: pointer;">Registrar</button>
                        </div>
                        <div id="kdd-user-status" style="padding: 10px; color: #666;">No registrado</div>
                    </div>

                    <div class="kdd-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Create Event -->
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fa-solid fa-plus-circle"></i> Crear Evento</h2>
                            </div>
                            <div class="card-body">
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label>Nombre del Evento</label>
                                    <input type="text" id="event-name" class="form-control" style="width: 100%; padding: 8px; margin-top: 5px;">
                                </div>
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label>Descripción</label>
                                    <textarea id="event-desc" class="form-control" style="width: 100%; padding: 8px; margin-top: 5px;"></textarea>
                                </div>
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label>Ubicación (Lat/Lon)</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="number" id="event-lat" placeholder="Lat" class="form-control" style="width: 50%; padding: 8px;">
                                        <input type="number" id="event-lon" placeholder="Lon" class="form-control" style="width: 50%; padding: 8px;">
                                    </div>
                                </div>
                                <button onclick="createKddEvent()" class="btn-primary" style="width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">Publicar Evento</button>
                            </div>
                        </div>

                        <!-- Event List -->
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fa-solid fa-map-location-dot"></i> Eventos Activos</h2>
                            </div>
                            <div class="card-body">
                                <div id="kdd-events-list" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Events here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="app.js"></script>
</body>
</html>

